package me.nullpoint.mod.modules.impl.exploit;

import com.mojang.authlib.GameProfile;
import me.nullpoint.api.events.eventbus.EventHandler;
import me.nullpoint.api.events.impl.PacketEvent;
import me.nullpoint.mod.modules.Module;
import me.nullpoint.mod.modules.impl.combat.Burrow;
import me.nullpoint.mod.modules.impl.combat.FeetTrap;
import me.nullpoint.mod.modules.settings.impl.BooleanSetting;
import net.minecraft.client.network.OtherClientPlayerEntity;
import net.minecraft.entity.Entity;
import net.minecraft.network.packet.Packet;
import net.minecraft.network.packet.c2s.common.KeepAliveC2SPacket;
import net.minecraft.network.packet.c2s.play.*;
import me.nullpoint.mod.modules.impl.combat.*;

import java.util.ArrayList;
import java.util.HashSet;
import java.util.Set;
import java.util.UUID;

public class Blink extends Module {
    public static Blink INSTANCE = new Blink();
    private final ArrayList<Packet> packetsList = new ArrayList<>();
    public static OtherClientPlayerEntity fakePlayer;

    // 新增：模块暂停控制
    private final Set<Module> pausedModules = new HashSet<>();

    private final BooleanSetting allPacket = add(new BooleanSetting("AllPacket", true));
    public final BooleanSetting autoBur = add(new BooleanSetting("AutoBur", true));
    public final BooleanSetting autoSur = add(new BooleanSetting("AutoSur", true));

    public Blink() {
        super("Blink", "Fake lag", Category.Exploit);
        INSTANCE = this;
    }

    @Override
    public void onEnable() {
        packetsList.clear();
        if (nullCheck()) {
            disable();
            return;
        }

        // 暂停战斗模块（类似ComboBreaks）
        pauseCombatModules();

        fakePlayer = new OtherClientPlayerEntity(mc.world, new GameProfile(
                UUID.fromString("11451466-6666-6666-6666-666666666601"),
                mc.player.getName().getString()
        ));

        fakePlayer.copyPositionAndRotation(mc.player);
        fakePlayer.bodyYaw = mc.player.bodyYaw;
        fakePlayer.headYaw = mc.player.headYaw;
        fakePlayer.getInventory().clone(mc.player.getInventory());
        mc.world.addEntity(fakePlayer);
    }

    @Override
    public void onUpdate() {
        if (mc.player != null && mc.player.isDead()) {
            packetsList.clear();
            disable();
        }
    }

    @Override
    public void onLogin() {
        if (this.isOn()) {
            packetsList.clear();
            disable();
        }
    }

    @EventHandler
    public void onSendPacket(PacketEvent.Send event) {
        Packet<?> t = event.getPacket();
        if (t instanceof ChatMessageC2SPacket ||
                t instanceof RequestCommandCompletionsC2SPacket ||
                t instanceof CommandExecutionC2SPacket ||
                t instanceof TeleportConfirmC2SPacket ||
                t instanceof KeepAliveC2SPacket ||
                t instanceof AdvancementTabC2SPacket ||
                t instanceof ClientStatusC2SPacket ||
                t instanceof ClickSlotC2SPacket) {
            return;
        }

        if (t instanceof PlayerMoveC2SPacket || allPacket.getValue()) {
            packetsList.add(event.getPacket());
            event.cancel();
        }
    }

    @Override
    public void onDisable() {
        if (nullCheck()) {
            packetsList.clear();
            return;
        }

        try {
            // 1. 移除假人实体
            if (fakePlayer != null) {
                fakePlayer.kill();
                fakePlayer.setRemoved(Entity.RemovalReason.KILLED);
                fakePlayer.onRemoved();
                fakePlayer = null;
            }

            // 2. 发送缓存的包
            for (Packet packet : packetsList) {
                if (mc.player != null && mc.player.networkHandler != null) {
                    mc.player.networkHandler.sendPacket(packet);
                }
            }

            // 3. 恢复战斗模块
            resumeCombatModules();

            // 4. 处理自动启用（在恢复后执行）
            if (autoBur.getValue() && Burrow.INSTANCE != null && !Burrow.INSTANCE.isOn()) {
                Burrow.INSTANCE.enable();
            }
            if (autoSur.getValue() && FeetTrap.INSTANCE != null && !FeetTrap.INSTANCE.isOn()) {
                FeetTrap.INSTANCE.enable();
            }
        } finally {
            packetsList.clear();
            pausedModules.clear();
        }
    }

    /**
     * 暂停战斗模块（类似ComboBreaks）
     */
    private void pauseCombatModules() {
        Module[] modulesToPause = {
                // 添加需要暂停的模块
                Criticals.INSTANCE, // 添加Criticals模块
                AutoCrystal.INSTANCE,
                AutoTrap.INSTANCE,
                HoleFiller.INSTANCE
        };

        for (Module module : modulesToPause) {
            if (module != null && module.isOn()) {
                module.disable();
                pausedModules.add(module);
            }
        }
    }

    /**
     * 恢复战斗模块
     */
    private void resumeCombatModules() {
        for (Module module : pausedModules) {
            if (module != null && !module.isOn()) {
                module.enable();
            }
        }
        pausedModules.clear();
    }

    @Override
    public String getInfo() {
        return String.valueOf(packetsList.size());
    }
}